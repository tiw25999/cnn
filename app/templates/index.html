<!-- app/templates/index.html -->
<!doctype html>
<html>
<head>
  <meta charset="utf-8" />
  <title>Upload & Predict</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    body { font-family: system-ui, sans-serif; max-width: 760px; margin: 40px auto; padding: 0 16px; }
    .card { border: 1px solid #ddd; border-radius: 12px; padding: 20px; }
    img { max-width: 100%; height: auto; display: block; margin-top: 12px; border-radius: 12px; }
    .result { margin-top: 12px; }
    button { padding: 8px 14px; border-radius: 8px; border: 1px solid #999; cursor: pointer; }
    input[type=file]{ margin: 8px 0; }
    pre { background: #f7f7f7; padding: 12px; border-radius: 8px; overflow: auto; }
    
    /* Two-card layout */
    .cards-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 16px; }
    @media (max-width: 820px) {
      .cards-grid { grid-template-columns: 1fr; }
    }

    /* Process cards layout */
    .process-cards-container {
      display: grid;
      grid-template-columns: repeat(3, 1fr);
      gap: 15px;
      margin: 20px 0;
    }

    .process-cards-container h3 {
      grid-column: 1 / -1;
      text-align: center;
      margin: 20px 0;
      color: #333;
      border-bottom: 2px solid #e0e0e0;
      padding-bottom: 10px;
    }

    .process-cards-container .card {
      min-height: 200px;
      text-align: center;
    }

    .process-cards-container .card h4 {
      font-size: 0.9em;
      margin: 8px 0;
      color: #555;
    }

    .process-cards-container .card img {
      max-width: 100%;
      max-height: 120px;
      object-fit: contain;
      border: 1px solid #ddd;
      border-radius: 4px;
    }

    .step-description {
      font-size: 0.8em;
      color: #666;
      margin: 5px 0;
      line-height: 1.3;
    }

    @media (max-width: 768px) {
      .process-cards-container {
        grid-template-columns: 1fr;
      }
    }
    
    /* Detection info styles */
    .detection-item {
      background: white;
      border: 1px solid #ddd;
      border-radius: 6px;
      padding: 8px 12px;
      margin: 4px 0;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }
    .detection-class {
      font-weight: bold;
      color: #333;
    }
    .detection-confidence {
      color: #666;
      font-size: 0.9em;
    }
  </style>
</head>
<body>
  <h1>‡∏£‡∏∞‡∏ö‡∏ö‡∏ï‡∏£‡∏ß‡∏à‡∏à‡∏±‡∏ö‡∏ï‡∏±‡∏ß‡πÄ‡∏•‡∏Ç‡πÉ‡∏ô‡∏†‡∏≤‡∏û</h1>
  <div class="card">
    <form id="form">
      <input type="file" id="file" name="file" accept="image/*" required />
      <button type="submit">‡∏ï‡∏£‡∏ß‡∏à‡∏à‡∏±‡∏ö‡∏ï‡∏±‡∏ß‡πÄ‡∏•‡∏Ç</button>
      <button type="button" id="reload-model-btn" style="margin-left: 8px; background: #28a745; color: white; border: none;">‡∏£‡∏µ‡πÇ‡∏´‡∏•‡∏î‡πÇ‡∏°‡πÄ‡∏î‡∏•</button>
    </form>

    <div id="preview">
        <div id="image-cards" class="cards-grid" style="display: none;">
            <div class="card">
                <h3>‡∏†‡∏≤‡∏û‡∏ï‡πâ‡∏ô‡∏â‡∏ö‡∏±‡∏ö</h3>
                <img id="original-image" alt="Original input image" />
            </div>
            <div class="card">
                <h3>‡∏†‡∏≤‡∏û‡∏ó‡∏µ‡πà‡∏ï‡∏£‡∏ß‡∏à‡∏à‡∏±‡∏ö‡∏ï‡∏±‡∏ß‡πÄ‡∏•‡∏Ç</h3>
                <img id="detection-image" alt="Image with detection boxes" />
                <div id="no-detection-note" style="display:none; color:#666; font-size: 0.9em; margin-top:8px;">‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏Å‡∏≤‡∏£‡∏ï‡∏£‡∏ß‡∏à‡∏à‡∏±‡∏ö‡∏ï‡∏±‡∏ß‡πÄ‡∏•‡∏Ç ‡∏à‡∏∞‡πÅ‡∏™‡∏î‡∏á‡∏†‡∏≤‡∏û‡πÄ‡∏î‡∏¥‡∏°</div>
            </div>
        </div>

        <!-- Card ‡πÅ‡∏™‡∏î‡∏á‡∏Ç‡∏±‡πâ‡∏ô‡∏ï‡∏≠‡∏ô‡∏Å‡∏≤‡∏£‡∏õ‡∏£‡∏∞‡∏°‡∏ß‡∏•‡∏ú‡∏• -->
        <div id="process-cards" class="process-cards-container" style="display: none;">
            <h3 style="grid-column: 1 / -1; text-align: center; margin: 20px 0; color: #333;">‡∏Ç‡∏±‡πâ‡∏ô‡∏ï‡∏≠‡∏ô‡∏Å‡∏≤‡∏£‡∏õ‡∏£‡∏∞‡∏°‡∏ß‡∏•‡∏ú‡∏•‡∏†‡∏≤‡∏û</h3>
            
            <!-- Row 1: ‡∏Ç‡∏±‡πâ‡∏ô‡∏ï‡∏≠‡∏ô‡∏´‡∏•‡∏±‡∏Å -->
            <div class="card">
                <h4>1. ‡πÅ‡∏ñ‡∏ö‡∏ö‡∏£‡∏£‡∏ó‡∏±‡∏î‡∏ö‡∏ô (12-62%)</h4>
                <img id="band-crop-image" alt="Band crop" />
                <p class="step-description">‡∏Ñ‡∏£‡∏≠‡∏õ‡πÅ‡∏ñ‡∏ö‡∏ö‡∏£‡∏£‡∏ó‡∏±‡∏î‡∏ö‡∏ô 12-62% ‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏ß‡∏≤‡∏°‡∏™‡∏π‡∏á‡∏†‡∏≤‡∏û</p>
            </div>
            <div class="card">
                <h4>2. Grayscale + Threshold</h4>
                <img id="threshold-image" alt="Threshold" />
                <p class="step-description">‡πÅ‡∏õ‡∏•‡∏á‡πÄ‡∏õ‡πá‡∏ô‡πÄ‡∏ó‡∏≤ + Otsu threshold</p>
            </div>
            <div class="card">
                <h4>3. Vertical Projection</h4>
                <img id="projection-image" alt="Vertical projection" />
                <p class="step-description">‡∏´‡∏≤‡∏ä‡πà‡∏ß‡∏á‡∏Ñ‡∏≠‡∏•‡∏±‡∏°‡∏ô‡πå‡∏ó‡∏µ‡πà‡∏°‡∏µ‡∏´‡∏°‡∏∂‡∏Å</p>
            </div>

            <!-- Row 2: ‡∏Å‡∏≤‡∏£‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏Å‡∏•‡πà‡∏≠‡∏á -->
            <div class="card">
                <h4>4. ‡∏Å‡∏•‡πà‡∏≠‡∏á‡∏ï‡∏±‡∏ß‡∏≠‡∏±‡∏Å‡∏©‡∏£</h4>
                <img id="boxes-image" alt="Character boxes" />
                <p class="step-description">‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏Å‡∏•‡πà‡∏≠‡∏á‡∏à‡∏≤‡∏Å‡∏ä‡πà‡∏ß‡∏á‡∏Ñ‡∏≠‡∏•‡∏±‡∏°‡∏ô‡πå</p>
            </div>
            <div class="card">
                <h4>5. Crop + Padding</h4>
                <img id="crop-image" alt="Cropped characters" />
                <p class="step-description">‡∏ï‡∏±‡∏î‡∏Å‡∏•‡πà‡∏≠‡∏á + ‡πÄ‡∏û‡∏¥‡πà‡∏° padding 5%</p>
            </div>
            <div class="card">
                <h4>6. Square Pad</h4>
                <img id="square-pad-image" alt="Square padded" />
                <p class="step-description">‡πÉ‡∏™‡πà‡πÅ‡∏ñ‡∏ö‡∏Ç‡∏≤‡∏ß‡πÉ‡∏´‡πâ‡πÄ‡∏õ‡πá‡∏ô‡∏™‡∏µ‡πà‡πÄ‡∏´‡∏•‡∏µ‡πà‡∏¢‡∏°‡∏à‡∏±‡∏ï‡∏∏‡∏£‡∏±‡∏™</p>
            </div>
            <div class="card">
                <h4>7. Resize 244√ó244</h4>
                <img id="resize244-image" alt="Resized to 244x244" />
                <p class="step-description">‡∏õ‡∏£‡∏±‡∏ö‡∏Ç‡∏ô‡∏≤‡∏î‡πÄ‡∏õ‡πá‡∏ô 244√ó244</p>
            </div>

        <!-- Row 3: ‡∏Å‡∏≤‡∏£‡πÄ‡∏ï‡∏£‡∏µ‡∏¢‡∏°‡∏™‡πà‡∏á‡πÇ‡∏°‡πÄ‡∏î‡∏• -->
        <div class="card">
            <h4>8. Grayscale</h4>
            <img id="grayscale-rgb-image" alt="Grayscale" />
            <p class="step-description">‡πÅ‡∏õ‡∏•‡∏á‡πÄ‡∏õ‡πá‡∏ô‡πÄ‡∏ó‡∏≤ (‡∏Ç‡∏≤‡∏ß‡∏î‡∏≥)</p>
        </div>
        </div>
    </div>
    <div class="result">
      <h3>‡∏ú‡∏•‡∏•‡∏±‡∏û‡∏ò‡πå</h3>
      <div id="detection-info" style="background: #f0f8ff; padding: 12px; border-radius: 8px; margin-bottom: 12px; display: none;">
        <h4 style="margin: 0 0 8px 0; color: #0066cc;">üéØ ‡∏ú‡∏•‡∏Å‡∏≤‡∏£‡∏ï‡∏£‡∏ß‡∏à‡∏à‡∏±‡∏ö‡∏ï‡∏±‡∏ß‡πÄ‡∏•‡∏Ç</h4>
        <div id="detection-details"></div>
      </div>
      <div id="model-info" style="background: #e8f4fd; padding: 12px; border-radius: 8px; margin-bottom: 12px; display: none;">
        <h4 style="margin: 0 0 8px 0; color: #0066cc;">ü§ñ ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÇ‡∏°‡πÄ‡∏î‡∏•</h4>
        <div id="model-details"></div>
      </div>
      <pre id="out">{}</pre>
    </div>
  </div>

  <script>
    const form = document.getElementById('form');
    const out = document.getElementById('out');
    const preview = document.getElementById('preview');
    const imageCards = document.getElementById('image-cards');
    const processCards = document.getElementById('process-cards');
    const originalImage = document.getElementById('original-image');
    const detectionImage = document.getElementById('detection-image');
    const noDetectionNote = document.getElementById('no-detection-note');
    const modelInfo = document.getElementById('model-info');
    const modelDetails = document.getElementById('model-details');
    const detectionInfo = document.getElementById('detection-info');
    const detectionDetails = document.getElementById('detection-details');
    const reloadModelBtn = document.getElementById('reload-model-btn');

    // no tabs needed anymore

    // ‡∏£‡∏µ‡πÇ‡∏´‡∏•‡∏î‡πÇ‡∏°‡πÄ‡∏î‡∏•
    reloadModelBtn.addEventListener('click', async () => {
      reloadModelBtn.disabled = true;
      reloadModelBtn.textContent = '‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏£‡∏µ‡πÇ‡∏´‡∏•‡∏î...';
      
      try {
        // ‡∏•‡∏≠‡∏á‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö endpoint ‡∏Å‡πà‡∏≠‡∏ô
        const checkResp = await fetch('/health');
        if (!checkResp.ok) {
          throw new Error(`Health check failed: ${checkResp.status}`);
        }
        
        // ‡∏•‡∏≠‡∏á‡πÉ‡∏ä‡πâ GET ‡∏Å‡πà‡∏≠‡∏ô
        let resp = await fetch('/reload-model', { method: 'GET' });
        
        if (resp.ok) {
          const checkData = await resp.json();
          console.log('GET /reload-model response:', checkData);
        }
        
        // ‡πÉ‡∏ä‡πâ POST ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏£‡∏µ‡πÇ‡∏´‡∏•‡∏î‡∏à‡∏£‡∏¥‡∏á
        resp = await fetch('/reload-model', { method: 'POST' });
        
        if (!resp.ok) {
          throw new Error(`HTTP error! status: ${resp.status}`);
        }
        
        const data = await resp.json();
        
        if (data.ok) {
          alert('‡∏£‡∏µ‡πÇ‡∏´‡∏•‡∏î‡πÇ‡∏°‡πÄ‡∏î‡∏•‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢‡πÅ‡∏•‡πâ‡∏ß! ‡πÇ‡∏°‡πÄ‡∏î‡∏•‡πÉ‡∏´‡∏°‡πà: ' + (data.model_info?.model_name || 'Unknown'));
          // ‡∏£‡∏µ‡πÄ‡∏ü‡∏£‡∏ä‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÇ‡∏°‡πÄ‡∏î‡∏•
          const modelResp = await fetch('/model-info');
          const modelData = await modelResp.json();
          
          if (modelData.model_name) {
            modelDetails.innerHTML = `
              <div><strong>Model Name:</strong> ${modelData.model_name}</div>
              <div><strong>File Size:</strong> ${modelData.file_size_mb} MB</div>
              <div><strong>Path:</strong> ${modelData.model_path}</div>
            `;
            modelInfo.style.display = 'block';
          }
        } else {
          const errorMsg = data.error || '‡πÑ‡∏°‡πà‡∏ó‡∏£‡∏≤‡∏ö‡∏™‡∏≤‡πÄ‡∏´‡∏ï‡∏∏';
          alert('‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏£‡∏µ‡πÇ‡∏´‡∏•‡∏î‡πÇ‡∏°‡πÄ‡∏î‡∏•‡πÑ‡∏î‡πâ: ' + errorMsg);
        }
      } catch (err) {
        console.error('Reload model error:', err);
        alert('‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠: ' + err.message + '\n\n‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏£‡∏µ‡∏™‡∏ï‡∏≤‡∏£‡πå‡∏ó‡πÅ‡∏≠‡∏õ‡πÅ‡∏•‡πâ‡∏ß‡∏•‡∏≠‡∏á‡πÉ‡∏´‡∏°‡πà');
      } finally {
        reloadModelBtn.disabled = false;
        reloadModelBtn.textContent = '‡∏£‡∏µ‡πÇ‡∏´‡∏•‡∏î‡πÇ‡∏°‡πÄ‡∏î‡∏•';
      }
    });

    // ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡πÅ‡∏™‡∏î‡∏á‡∏†‡∏≤‡∏û‡∏Ç‡∏±‡πâ‡∏ô‡∏ï‡∏≠‡∏ô‡∏Å‡∏≤‡∏£‡∏õ‡∏£‡∏∞‡∏°‡∏ß‡∏•‡∏ú‡∏•
    function displayProcessSteps(steps) {
      console.log('Displaying process steps:', steps);
      
      if (steps.band_crop) {
        console.log('Setting band_crop image');
        document.getElementById('band-crop-image').src = steps.band_crop;
      }
      if (steps.threshold) {
        console.log('Setting threshold image');
        document.getElementById('threshold-image').src = steps.threshold;
      }
      if (steps.projection) {
        console.log('Setting projection image');
        document.getElementById('projection-image').src = steps.projection;
      }
      if (steps.boxes) {
        console.log('Setting boxes image');
        document.getElementById('boxes-image').src = steps.boxes;
      }
      if (steps.crop) {
        console.log('Setting crop image');
        document.getElementById('crop-image').src = steps.crop;
      }
      if (steps.square_pad) {
        console.log('Setting square_pad image');
        document.getElementById('square-pad-image').src = steps.square_pad;
      }
      if (steps.resize244) {
        console.log('Setting resize244 image');
        document.getElementById('resize244-image').src = steps.resize244;
      }
        // ‡∏Ç‡∏±‡πâ‡∏ô‡∏ï‡∏≠‡∏ô‡∏ó‡∏µ‡πà 8 ‡∏ñ‡∏π‡∏Å‡∏•‡∏ö‡∏≠‡∏≠‡∏Å‡πÅ‡∏•‡πâ‡∏ß
      if (steps.grayscale_rgb) {
        console.log('Setting grayscale_rgb image');
        document.getElementById('grayscale-rgb-image').src = steps.grayscale_rgb;
      }
      // ‡∏Ç‡∏±‡πâ‡∏ô‡∏ï‡∏≠‡∏ô Final Input ‡∏ñ‡∏π‡∏Å‡∏•‡∏ö‡∏≠‡∏≠‡∏Å‡πÅ‡∏•‡πâ‡∏ß
    }

    form.addEventListener('submit', async (e) => {
      e.preventDefault();
      const file = document.getElementById('file').files[0];
      if (!file) return;

      const fd = new FormData();
      fd.append('file', file);

      out.textContent = '‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏ï‡∏£‡∏ß‡∏à‡∏à‡∏±‡∏ö‡∏ï‡∏±‡∏ß‡πÄ‡∏•‡∏Ç...';
      // ‡πÅ‡∏™‡∏î‡∏á‡∏Å‡∏≤‡∏£‡πå‡∏î‡∏†‡∏≤‡∏û‡∏ó‡∏±‡πâ‡∏á‡∏™‡∏≠‡∏á‡πÉ‡∏ö
      imageCards.style.display = 'grid';
      modelInfo.style.display = 'none';
      detectionInfo.style.display = 'none';
      
      // ‡πÅ‡∏™‡∏î‡∏á progress indicator ‡∏ó‡∏µ‡πà‡∏î‡∏µ‡∏Ç‡∏∂‡πâ‡∏ô
      const progressDiv = document.createElement('div');
      progressDiv.id = 'progress-indicator';
      progressDiv.style.cssText = 'background: linear-gradient(90deg, #e3f2fd, #bbdefb); padding: 16px; border-radius: 8px; margin: 12px 0; text-align: center; border-left: 4px solid #2196f3;';
      
      const fileSize = (file.size / 1024 / 1024).toFixed(1);
      let progressText = 'üîÑ ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏õ‡∏£‡∏∞‡∏°‡∏ß‡∏•‡∏ú‡∏•‡∏†‡∏≤‡∏û...';
      if (fileSize > 2) {
        progressText += `<br><small style="color: #666;">‡∏†‡∏≤‡∏û‡∏Ç‡∏ô‡∏≤‡∏î‡πÉ‡∏´‡∏ç‡πà (${fileSize} MB) - ‡∏≠‡∏≤‡∏à‡πÉ‡∏ä‡πâ‡πÄ‡∏ß‡∏•‡∏≤‡∏ô‡∏≤‡∏ô</small>`;
      } else if (fileSize > 0.5) {
        progressText += `<br><small style="color: #666;">‡∏†‡∏≤‡∏û‡∏Ç‡∏ô‡∏≤‡∏î‡∏Å‡∏•‡∏≤‡∏á (${fileSize} MB) - ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏£‡∏≠‡∏™‡∏±‡∏Å‡∏Ñ‡∏£‡∏π‡πà...</small>`;
      } else {
        progressText += `<br><small style="color: #666;">‡∏†‡∏≤‡∏û‡∏Ç‡∏ô‡∏≤‡∏î‡πÄ‡∏•‡πá‡∏Å (${fileSize} MB) - ‡∏õ‡∏£‡∏∞‡∏°‡∏ß‡∏•‡∏ú‡∏•‡πÄ‡∏£‡πá‡∏ß</small>`;
      }
      
      progressDiv.innerHTML = progressText;
      out.parentNode.insertBefore(progressDiv, out);
      
      // ‡∏õ‡∏¥‡∏î‡∏Å‡∏≤‡∏£‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô‡∏õ‡∏∏‡πà‡∏° submit ‡∏ä‡∏±‡πà‡∏ß‡∏Ñ‡∏£‡∏≤‡∏ß
      const submitBtn = form.querySelector('button[type="submit"]');
      submitBtn.disabled = true;
      submitBtn.textContent = '‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏õ‡∏£‡∏∞‡∏°‡∏ß‡∏•‡∏ú‡∏•...';

      try {
        const resp = await fetch('/predict', { method: 'POST', body: fd });
        const data = await resp.json();
        out.textContent = JSON.stringify(data, null, 2);
        
        // ‡∏•‡∏ö progress indicator ‡πÅ‡∏•‡∏∞‡πÄ‡∏õ‡∏¥‡∏î‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô‡∏õ‡∏∏‡πà‡∏°
        const progressDiv = document.getElementById('progress-indicator');
        if (progressDiv) {
          progressDiv.remove();
        }
        
        // ‡πÄ‡∏õ‡∏¥‡∏î‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô‡∏õ‡∏∏‡πà‡∏° submit ‡∏Å‡∏•‡∏±‡∏ö
        const submitBtn = form.querySelector('button[type="submit"]');
        submitBtn.disabled = false;
        submitBtn.textContent = '‡∏ï‡∏£‡∏ß‡∏à‡∏à‡∏±‡∏ö‡∏ï‡∏±‡∏ß‡πÄ‡∏•‡∏Ç';
        
        // ‡πÅ‡∏™‡∏î‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÇ‡∏°‡πÄ‡∏î‡∏•
        if (data.ok && data.model_info) {
          modelDetails.innerHTML = `
            <div><strong>Model Name:</strong> ${data.model_info.name}</div>
            <div><strong>File Size:</strong> ${data.model_info.size_mb} MB</div>
            <div><strong>Path:</strong> ${data.model_info.path}</div>
          `;
          modelInfo.style.display = 'block';
        }
        
        // ‡πÅ‡∏™‡∏î‡∏á‡∏†‡∏≤‡∏û‡∏ó‡∏±‡πâ‡∏á‡∏™‡∏≠‡∏á‡πÉ‡∏ö
        if (data.ok && data.preview_base64) {
          originalImage.src = data.preview_base64;
          imageCards.style.display = 'grid';
          processCards.style.display = 'grid';
        }
        if (data.ok && data.preview_with_boxes_base64) {
          detectionImage.src = data.preview_with_boxes_base64;
          if (noDetectionNote) noDetectionNote.style.display = 'none';
        } else {
          // ‡∏´‡∏≤‡∏Å‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏†‡∏≤‡∏û‡∏ó‡∏µ‡πà‡∏ß‡∏≤‡∏î‡∏Å‡∏£‡∏≠‡∏ö ‡πÉ‡∏´‡πâ‡πÉ‡∏ä‡πâ‡∏†‡∏≤‡∏û‡πÄ‡∏î‡∏¥‡∏°‡πÅ‡∏•‡∏∞‡πÅ‡∏à‡πâ‡∏á‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ
          detectionImage.src = data.preview_base64 || '';
          if (noDetectionNote) noDetectionNote.style.display = 'block';
        }

        // ‡πÅ‡∏™‡∏î‡∏á‡∏†‡∏≤‡∏û‡∏Ç‡∏±‡πâ‡∏ô‡∏ï‡∏≠‡∏ô‡∏Å‡∏≤‡∏£‡∏õ‡∏£‡∏∞‡∏°‡∏ß‡∏•‡∏ú‡∏•
        console.log('Full response data:', data);
        if (data.process_steps) {
          console.log('Process steps received:', Object.keys(data.process_steps));
          displayProcessSteps(data.process_steps);
        } else if (data.result && data.result.process_steps) {
          console.log('Process steps in result:', Object.keys(data.result.process_steps));
          displayProcessSteps(data.result.process_steps);
        } else {
          console.log('No process steps received');
        }
        
        // ‡πÅ‡∏™‡∏î‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏Å‡∏≤‡∏£‡∏ï‡∏£‡∏ß‡∏à‡∏à‡∏±‡∏ö‡∏ß‡∏±‡∏ï‡∏ñ‡∏∏
        if (data.ok && data.result && data.result.detections && data.result.detections.length > 0) {
          const detections = data.result.detections;
          const stats = data.result.detection_stats || {};
          
          let detectionHTML = `<div><strong>‡∏û‡∏ö‡∏ï‡∏±‡∏ß‡πÄ‡∏•‡∏Ç ${detections.length} ‡∏ï‡∏±‡∏ß:</strong></div>`;
          
          // ‡πÅ‡∏™‡∏î‡∏á‡∏™‡∏ñ‡∏¥‡∏ï‡∏¥‡∏Ñ‡∏•‡∏≤‡∏™
          if (stats.class_counts) {
            detectionHTML += `<div style="margin: 8px 0; padding: 8px; background: #f8f9fa; border-radius: 4px;">`;
            detectionHTML += `<strong>‡∏ï‡∏±‡∏ß‡πÄ‡∏•‡∏Ç‡∏ó‡∏µ‡πà‡∏û‡∏ö:</strong><br>`;
            for (const [classId, count] of Object.entries(stats.class_counts)) {
              detectionHTML += `‡πÄ‡∏•‡∏Ç ${classId}: ${count} ‡∏ï‡∏±‡∏ß<br>`;
            }
            detectionHTML += `</div>`;
          }
          
          detections.forEach((detection, index) => {
            detectionHTML += `
              <div class="detection-item">
                <div>
                  <span class="detection-class">${detection.class_name}</span>
                  <div style="font-size: 0.8em; color: #666;">
                    ‡∏ï‡∏≥‡πÅ‡∏´‡∏ô‡πà‡∏á: (${detection.bbox[0]}, ${detection.bbox[1]}) ‡∏ñ‡∏∂‡∏á (${detection.bbox[2]}, ${detection.bbox[3]})
                  </div>
                </div>
                <div class="detection-confidence">${(detection.confidence * 100).toFixed(1)}%</div>
              </div>
            `;
          });
          
          detectionDetails.innerHTML = detectionHTML;
          detectionInfo.style.display = 'block';
        }
        
      } catch (err) {
        out.textContent = String(err);
        
        // ‡∏•‡∏ö progress indicator ‡πÉ‡∏ô‡∏Å‡∏£‡∏ì‡∏µ error ‡πÅ‡∏•‡∏∞‡πÄ‡∏õ‡∏¥‡∏î‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô‡∏õ‡∏∏‡πà‡∏°
        const progressDiv = document.getElementById('progress-indicator');
        if (progressDiv) {
          progressDiv.remove();
        }
        
        // ‡πÄ‡∏õ‡∏¥‡∏î‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô‡∏õ‡∏∏‡πà‡∏° submit ‡∏Å‡∏•‡∏±‡∏ö
        const submitBtn = form.querySelector('button[type="submit"]');
        submitBtn.disabled = false;
        submitBtn.textContent = '‡∏ï‡∏£‡∏ß‡∏à‡∏à‡∏±‡∏ö‡∏ï‡∏±‡∏ß‡πÄ‡∏•‡∏Ç';
      }
    });
  </script>
</body>
</html>
