<!-- app/templates/index.html -->
<!doctype html>
<html lang="th">
<head>
  <meta charset="utf-8" />
  <title>AI License Plate Detection System</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <meta name="description" content="AI-powered license plate detection system with modern web interface" />
  <meta name="theme-color" content="#2563eb" />
  
  <!-- Performance optimizations -->
  <meta http-equiv="Cache-Control" content="max-age=31536000" />
  <meta http-equiv="Expires" content="31536000" />
  
  <!-- Preload critical resources -->
  <link rel="preload" href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" as="style" onload="this.onload=null;this.rel='stylesheet'">
  
  <!-- Fallback for non-JS browsers -->
  <noscript>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
  </noscript>
  <style>
    :root {
      --primary-blue: #2563eb;
      --light-blue: #dbeafe;
      --dark-blue: #1e40af;
      --white: #ffffff;
      --gray-50: #f8fafc;
      --gray-100: #f1f5f9;
      --gray-200: #e2e8f0;
      --gray-300: #cbd5e1;
      --gray-400: #94a3b8;
      --gray-500: #64748b;
      --gray-600: #475569;
      --gray-700: #334155;
      --gray-800: #1e293b;
      --gray-900: #0f172a;
      --success: #10b981;
      --warning: #f59e0b;
      --error: #ef4444;
      --shadow-sm: 0 1px 2px 0 rgb(0 0 0 / 0.05);
      --shadow-md: 0 4px 6px -1px rgb(0 0 0 / 0.1), 0 2px 4px -2px rgb(0 0 0 / 0.1);
      --shadow-lg: 0 10px 15px -3px rgb(0 0 0 / 0.1), 0 4px 6px -4px rgb(0 0 0 / 0.1);
      --shadow-xl: 0 20px 25px -5px rgb(0 0 0 / 0.1), 0 8px 10px -6px rgb(0 0 0 / 0.1);
    }

    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    body {
      font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
      background: linear-gradient(135deg, var(--gray-50) 0%, var(--light-blue) 100%);
      min-height: 100vh;
      color: var(--gray-800);
      line-height: 1.6;
    }

    .container {
      max-width: 1200px;
      margin: 0 auto;
      padding: 0 20px;
    }

    /* Header */
    .header {
      background: var(--white);
      box-shadow: var(--shadow-sm);
      position: sticky;
      top: 0;
      z-index: 100;
      border-bottom: 1px solid var(--gray-200);
    }

    .header-content {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 1rem 0;
    }

    .logo {
      display: flex;
      align-items: center;
      gap: 0.75rem;
    }

    .logo-icon {
      width: 40px;
      height: 40px;
      background: linear-gradient(135deg, var(--primary-blue), var(--dark-blue));
      border-radius: 12px;
      display: flex;
      align-items: center;
      justify-content: center;
      color: var(--white);
      font-size: 1.25rem;
      font-weight: 700;
    }

    .logo-text {
      font-size: 1.5rem;
      font-weight: 700;
      color: var(--gray-900);
    }

    .dev-mode-toggle {
      background: var(--gray-100);
      color: var(--gray-600);
      border: 1px solid var(--gray-300);
      padding: 0.5rem 1rem;
      border-radius: 8px;
      cursor: pointer;
      font-size: 0.875rem;
      font-weight: 500;
      transition: all 0.2s ease;
      display: flex;
      align-items: center;
      gap: 0.5rem;
    }

    .dev-mode-toggle:hover {
      background: var(--gray-200);
      transform: translateY(-1px);
    }

    .dev-mode-toggle.active {
      background: var(--primary-blue);
      color: var(--white);
      border-color: var(--primary-blue);
    }

    /* Main Content */
    .main-content {
      padding: 2rem 0;
    }

    .hero-section {
      text-align: center;
      margin-bottom: 3rem;
    }

    .hero-title {
      font-size: 3rem;
      font-weight: 700;
      color: var(--gray-900);
      margin-bottom: 1rem;
      background: linear-gradient(135deg, var(--primary-blue), var(--dark-blue));
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
      background-clip: text;
    }

    .hero-subtitle {
      font-size: 1.25rem;
      color: var(--gray-600);
      margin-bottom: 2rem;
    }


    /* Cards */
    .card {
      background: var(--white);
      border-radius: 16px;
      padding: 2rem;
      box-shadow: var(--shadow-md);
      border: 1px solid var(--gray-200);
      transition: all 0.3s ease;
    }

    .card:hover {
      box-shadow: var(--shadow-lg);
      transform: translateY(-2px);
    }

    .card-header {
      display: flex;
      align-items: center;
      gap: 0.75rem;
      margin-bottom: 1.5rem;
    }

    .card-icon {
      width: 32px;
      height: 32px;
      background: var(--light-blue);
      border-radius: 8px;
      display: flex;
      align-items: center;
      justify-content: center;
      color: var(--primary-blue);
      font-size: 1rem;
    }

    .card-title {
      font-size: 1.25rem;
      font-weight: 600;
      color: var(--gray-900);
    }

    /* Upload Section */
    .upload-section {
      margin-bottom: 2rem;
    }

    .upload-area {
      border: 2px dashed var(--gray-300);
      border-radius: 12px;
      padding: 3rem 2rem;
      text-align: center;
      transition: all 0.3s ease;
      cursor: pointer;
      background: var(--gray-50);
    }

    .upload-area:hover {
      border-color: var(--primary-blue);
      background: var(--light-blue);
    }

    .upload-area.dragover {
      border-color: var(--primary-blue);
      background: var(--light-blue);
      transform: scale(1.02);
    }

    .upload-icon {
      font-size: 3rem;
      color: var(--gray-400);
      margin-bottom: 1rem;
    }

    .upload-text {
      font-size: 1.125rem;
      color: var(--gray-600);
      margin-bottom: 0.5rem;
    }

    .upload-subtext {
      font-size: 0.875rem;
      color: var(--gray-500);
    }

    .file-input {
      display: none;
    }

    .btn {
      padding: 0.75rem 1.5rem;
      border-radius: 8px;
      border: none;
      font-weight: 500;
      cursor: pointer;
      transition: all 0.2s ease;
      display: inline-flex;
      align-items: center;
      gap: 0.5rem;
      font-size: 0.875rem;
    }

    .btn-primary {
      background: var(--primary-blue);
      color: var(--white);
    }

    .btn-primary:hover {
      background: var(--dark-blue);
      transform: translateY(-1px);
      box-shadow: var(--shadow-md);
    }

    .btn-secondary {
      background: var(--gray-100);
      color: var(--gray-700);
      border: 1px solid var(--gray-300);
    }

    .btn-secondary:hover {
      background: var(--gray-200);
    }

    .btn-success {
      background: var(--success);
      color: var(--white);
    }

    .btn-success:hover {
      background: #059669;
    }

    /* Model Selection */
    .model-selection {
      margin-bottom: 1.5rem;
      padding: 1.5rem;
      background: var(--gray-50);
      border-radius: 12px;
      border: 1px solid var(--gray-200);
    }

    .model-selection.hidden {
      display: none;
    }

    .model-label {
      font-weight: 500;
      color: var(--gray-700);
      margin-bottom: 0.5rem;
      display: flex;
      align-items: center;
      gap: 0.5rem;
    }

    .model-select {
      width: 100%;
      padding: 0.75rem;
      border: 1px solid var(--gray-300);
      border-radius: 8px;
      background: var(--white);
      color: var(--gray-700);
      font-size: 0.875rem;
    }

    .model-select:focus {
      outline: none;
      border-color: var(--primary-blue);
      box-shadow: 0 0 0 3px var(--light-blue);
    }

    /* Results Section */
    .results-section {
      margin-top: 2rem;
    }

    .results-grid {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 2rem;
      margin-bottom: 2rem;
    }

    @media (max-width: 768px) {
      .results-grid {
        grid-template-columns: 1fr;
      }
    }
    
    .result-image {
      width: 100%;
      height: auto;
      border-radius: 12px;
      box-shadow: var(--shadow-md);
      transition: opacity 0.3s ease;
    }

    .result-image[data-loaded="false"] {
      opacity: 0;
    }

    .result-image[data-loaded="true"] {
      opacity: 1;
    }

    .no-detection-note {
      color: var(--gray-500);
      font-size: 0.875rem;
      margin-top: 0.5rem;
      text-align: center;
      padding: 1rem;
      background: var(--gray-50);
      border-radius: 8px;
    }

    /* Process Steps */
    .process-steps {
      margin-top: 2rem;
    }

    .process-steps.hidden {
      display: none;
    }

    .process-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
      gap: 1.5rem;
      margin-top: 1.5rem;
    }

    .process-card {
      background: var(--white);
      border-radius: 12px;
      padding: 1.5rem;
      text-align: center;
      box-shadow: var(--shadow-sm);
      border: 1px solid var(--gray-200);
      transition: all 0.3s ease;
    }

    .process-card:hover {
      box-shadow: var(--shadow-md);
      transform: translateY(-2px);
    }

    .process-card img {
      width: 100%;
      height: 80px;
      object-fit: contain;
      border-radius: 8px;
      margin-bottom: 1rem;
      border: 1px solid var(--gray-200);
      transition: opacity 0.3s ease;
      background: linear-gradient(90deg, #f0f0f0 25%, #e0e0e0 50%, #f0f0f0 75%);
      background-size: 200% 100%;
      animation: loading 1.5s infinite;
    }

    .process-card img[data-loaded="false"] {
      opacity: 0;
    }

    .process-card img[data-loaded="true"] {
      opacity: 1;
      animation: none;
      background: none;
    }

    @keyframes loading {
      0% { background-position: 200% 0; }
      100% { background-position: -200% 0; }
    }

    .process-title {
      font-size: 1rem;
      font-weight: 600;
      color: var(--gray-900);
      margin-bottom: 0.5rem;
    }

    .process-description {
      font-size: 0.875rem;
      color: var(--gray-600);
      line-height: 1.4;
    }

    /* Detection Info */
    .detection-info {
      background: var(--light-blue);
      border: 1px solid var(--primary-blue);
      border-radius: 12px;
      padding: 1.5rem;
      margin-bottom: 1rem;
    }

    .detection-info.hidden {
      display: none;
    }

    .detection-title {
      font-size: 1.125rem;
      font-weight: 600;
      color: var(--primary-blue);
      margin-bottom: 1rem;
      display: flex;
      align-items: center;
      gap: 0.5rem;
    }

    .detection-item {
      background: var(--white);
      border: 1px solid var(--gray-200);
      border-radius: 8px;
      padding: 1rem;
      margin: 0.5rem 0;
      display: flex;
      justify-content: space-between;
      align-items: center;
      transition: all 0.2s ease;
    }

    .detection-item:hover {
      box-shadow: var(--shadow-sm);
      transform: translateY(-1px);
    }

    .detection-class {
      font-weight: 600;
      color: var(--gray-900);
    }

    .detection-confidence {
      color: var(--gray-600);
      font-size: 0.875rem;
      background: var(--gray-100);
      padding: 0.25rem 0.5rem;
      border-radius: 4px;
    }

    /* Model Info */
    .model-info {
      background: var(--gray-50);
      border: 1px solid var(--gray-200);
      border-radius: 12px;
      padding: 1.5rem;
      margin-bottom: 1rem;
    }

    .model-info.hidden {
      display: none;
    }

    .model-info-title {
      font-size: 1.125rem;
      font-weight: 600;
      color: var(--gray-700);
      margin-bottom: 1rem;
      display: flex;
      align-items: center;
      gap: 0.5rem;
    }

    .model-details {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
      gap: 1rem;
    }

    .model-detail-item {
      background: var(--white);
      padding: 1rem;
      border-radius: 8px;
      border: 1px solid var(--gray-200);
    }

    .model-detail-label {
      font-size: 0.875rem;
      color: var(--gray-600);
      margin-bottom: 0.25rem;
    }

    .model-detail-value {
      font-weight: 600;
      color: var(--gray-900);
      word-break: break-all;
      font-size: 0.875rem;
    }

    /* Status Messages */
    .status-message {
      padding: 1rem 1.5rem;
      border-radius: 8px;
      margin: 1rem 0;
      display: flex;
      align-items: center;
      gap: 0.75rem;
      font-weight: 500;
    }

    .status-success {
      background: #d1fae5;
      color: #065f46;
      border: 1px solid #a7f3d0;
    }

    .status-warning {
      background: #fef3c7;
      color: #92400e;
      border: 1px solid #fde68a;
    }

    .status-error {
      background: #fee2e2;
      color: #991b1b;
      border: 1px solid #fecaca;
    }

    .status-info {
      background: var(--light-blue);
      color: var(--dark-blue);
      border: 1px solid var(--primary-blue);
    }

    /* JSON Output */
    .json-output {
      background: var(--gray-900);
      color: var(--gray-100);
      padding: 1.5rem;
      border-radius: 12px;
      font-family: 'Monaco', 'Menlo', 'Ubuntu Mono', monospace;
      font-size: 0.875rem;
      line-height: 1.6;
      overflow-x: auto;
      margin-top: 1rem;
      border: 1px solid var(--gray-700);
      box-shadow: var(--shadow-lg);
    }

    .json-output.hidden {
      display: none;
    }

    .json-output pre {
      margin: 0;
      white-space: pre-wrap;
      word-wrap: break-word;
    }

    .json-output .json-key {
      color: #79b8ff;
      font-weight: 600;
    }

    .json-output .json-string {
      color: #9ecbff;
    }

    .json-output .json-number {
      color: #f97583;
    }

    .json-output .json-boolean {
      color: #ffab70;
    }

    .json-output .json-null {
      color: #8b949e;
    }

    /* Loading Animation */
    .loading-spinner {
      display: inline-block;
      width: 20px;
      height: 20px;
      border: 2px solid var(--gray-300);
      border-radius: 50%;
      border-top-color: var(--primary-blue);
      animation: spin 1s ease-in-out infinite;
    }

    @keyframes spin {
      to { transform: rotate(360deg); }
    }

    /* Responsive Design */
    @media (max-width: 768px) {
      .container {
        padding: 0 1rem;
      }

      .hero-title {
        font-size: 2rem;
      }


      .header-content {
        flex-direction: column;
        gap: 1rem;
      }

      .card {
        padding: 1.5rem;
      }

      .upload-area {
        padding: 2rem 1rem;
      }
    }

    /* Animations - Optimized with will-change */
    .fade-in {
      animation: fadeIn 0.5s ease-in-out;
      will-change: opacity, transform;
    }

    @keyframes fadeIn {
      from { opacity: 0; transform: translateY(20px); }
      to { opacity: 1; transform: translateY(0); }
    }

    .slide-up {
      animation: slideUp 0.3s ease-out;
      will-change: opacity, transform;
    }

    @keyframes slideUp {
      from { transform: translateY(10px); opacity: 0; }
      to { transform: translateY(0); opacity: 1; }
    }

    /* Performance optimizations */
    .card, .process-card, .detection-item {
      will-change: transform;
      backface-visibility: hidden;
      transform: translateZ(0);
    }

    /* Optimize text rendering */
    body {
      text-rendering: optimizeSpeed;
      -webkit-font-smoothing: antialiased;
      -moz-osx-font-smoothing: grayscale;
    }

    /* Optimize images */
    img {
      image-rendering: -webkit-optimize-contrast;
      image-rendering: crisp-edges;
    }
  </style>
</head>
<body>
  <!-- Header -->
  <header class="header">
    <div class="container">
      <div class="header-content">
        <div class="logo">
          <div class="logo-icon">
            AI
          </div>
          <div class="logo-text">AI License Plate Detection</div>
        </div>
        <button id="dev-mode-toggle" class="dev-mode-toggle">
          <span>Dev Mode: OFF</span>
        </button>
      </div>
    </div>
  </header>

  <!-- Main Content -->
  <main class="main-content">
    <div class="container">
      <!-- Hero Section -->
      <section class="hero-section">
        <h1 class="hero-title">ระบบตรวจจับป้ายทะเบียน</h1>
      </section>

      <!-- Upload Section -->
      <section class="upload-section">
  <div class="card">
          <div class="card-header">
            <div class="card-icon">
              📤
            </div>
            <h2 class="card-title">อัปโหลดภาพป้ายทะเบียน</h2>
          </div>
          
    <form id="form">
            <!-- Model Selection (Dev Mode Only) -->
            <div id="model-selection" class="model-selection hidden">
              <label for="model-select" class="model-label">
                🧠
                เลือกโมเดล AI
              </label>
              <select id="model-select" class="model-select">
                <option value="MobileNetV2_Augmented_best.keras">MobileNetV2 (Augmented)</option>
                <option value="EfficientNetB0_Augmented_best.keras">EfficientNetB0 (Augmented)</option>
                <option value="EfficientNetV2B0_Original_best.keras">EfficientNetV2B0 (Original)</option>
                <option value="MobileNetV3Large_Augmented_best.keras">MobileNetV3Large (Augmented)</option>
                <option value="NASNetMobile_Augmented_best.keras">NASNetMobile (Augmented)</option>
              </select>
            </div>
            
            <!-- Upload Area -->
            <div class="upload-area" id="upload-area">
              <div class="upload-icon">
                📁
              </div>
              <div class="upload-text">ลากและวางไฟล์ภาพที่นี่</div>
              <div class="upload-subtext">หรือคลิกเพื่อเลือกไฟล์ (JPG, PNG, GIF)</div>
              <input type="file" id="file" name="file" accept="image/*" class="file-input" required />
            </div>
            
            <!-- Action Buttons -->
            <div style="display: flex; gap: 1rem; margin-top: 1.5rem; justify-content: center;">
              <button type="submit" class="btn btn-primary">
                🔍
                ตรวจจับตัวเลข
              </button>
              <button type="button" id="reload-model-btn" class="btn btn-success hidden">
                🔄
                รีโหลดโมเดล
              </button>
            </div>
    </form>
        </div>
      </section>

      <!-- Results Section -->
      <section class="results-section" id="preview">
        <!-- Image Results -->
        <div id="image-cards" class="results-grid hidden">
            <div class="card">
            <div class="card-header">
              <div class="card-icon">
                🖼️
              </div>
              <h3 class="card-title">ภาพต้นฉบับ</h3>
            </div>
            <img id="original-image" class="result-image" alt="Original input image" />
            </div>
            <div class="card">
            <div class="card-header">
              <div class="card-icon">
                🔍
              </div>
              <h3 class="card-title">ผลการตรวจจับ</h3>
            </div>
            <img id="detection-image" class="result-image" alt="Image with detection boxes" />
            <div id="no-detection-note" class="no-detection-note hidden">
              ⚠️
              ไม่พบการตรวจจับตัวเลข จะแสดงภาพเดิม
            </div>
            </div>
        </div>

        <!-- Process Steps (Dev Mode Only) -->
        <div id="process-cards" class="process-steps hidden">
            <div class="card">
            <div class="card-header">
              <div class="card-icon">
                ⚙️
              </div>
              <h3 class="card-title">ขั้นตอนการประมวลผลภาพ (Dev Mode)</h3>
            </div>
            <div class="process-grid">
              <div class="process-card">
                <h4 class="process-title">1. แถบบรรทัดบน (12-62%)</h4>
                <img id="band-crop-image" alt="Band crop" />
                <p class="process-description">ครอปแถบบรรทัดบน 12-62% ของความสูงภาพ</p>
            </div>
              <div class="process-card">
                <h4 class="process-title">2. Grayscale + Threshold</h4>
                <img id="threshold-image" alt="Threshold" />
                <p class="process-description">แปลงเป็นเทา + Otsu threshold</p>
            </div>
              <div class="process-card">
                <h4 class="process-title">3. Vertical Projection</h4>
                <img id="projection-image" alt="Vertical projection" />
                <p class="process-description">หาช่วงคอลัมน์ที่มีหมึก</p>
            </div>
              <div class="process-card">
                <h4 class="process-title">4. กล่องตัวอักษร</h4>
                <img id="boxes-image" alt="Character boxes" />
                <p class="process-description">สร้างกล่องจากช่วงคอลัมน์</p>
            </div>
              <div class="process-card">
                <h4 class="process-title">5. Crop + Padding</h4>
                <img id="crop-image" alt="Cropped characters" />
                <p class="process-description">ตัดกล่อง + เพิ่ม padding 5%</p>
            </div>
              <div class="process-card">
                <h4 class="process-title">6. Square Pad</h4>
                <img id="square-pad-image" alt="Square padded" />
                <p class="process-description">ใส่แถบขาวให้เป็นสี่เหลี่ยมจัตุรัส</p>
            </div>
              <div class="process-card">
                <h4 class="process-title">7. Resize 224×224</h4>
                <img id="resize244-image" alt="Resized to 224x224" />
                <p class="process-description">ปรับขนาดเป็น 224×224</p>
            </div>
              <div class="process-card">
                <h4 class="process-title">8. Grayscale</h4>
            <img id="grayscale-rgb-image" alt="Grayscale" />
                <p class="process-description">แปลงเป็นเทา (ขาวดำ)</p>
        </div>
        </div>
    </div>
        </div>

        <!-- Detection Results -->
        <div id="detection-info" class="detection-info hidden">
          <h4 class="detection-title">
            🎯
            ผลการตรวจจับตัวเลข
          </h4>
        <div id="detection-details"></div>
      </div>

        <!-- Model Info (Dev Mode Only) -->
        <div id="model-info" class="model-info hidden">
          <h4 class="model-info-title">
            🤖
            ข้อมูลโมเดล AI
          </h4>
          <div id="model-details" class="model-details"></div>
      </div>

        <!-- JSON Output (Dev Mode Only) -->
        <div id="out" class="json-output hidden"></div>
      </section>
    </div>
  </main>

  <script>
    const form = document.getElementById('form');
    const out = document.getElementById('out');
    const preview = document.getElementById('preview');
    const imageCards = document.getElementById('image-cards');
    const processCards = document.getElementById('process-cards');
    const originalImage = document.getElementById('original-image');
    const detectionImage = document.getElementById('detection-image');
    const noDetectionNote = document.getElementById('no-detection-note');
    const modelInfo = document.getElementById('model-info');
    const modelDetails = document.getElementById('model-details');
    const detectionInfo = document.getElementById('detection-info');
    const detectionDetails = document.getElementById('detection-details');
    const reloadModelBtn = document.getElementById('reload-model-btn');
    const modelSelect = document.getElementById('model-select');
    const devModeToggle = document.getElementById('dev-mode-toggle');
    const modelSelection = document.getElementById('model-selection');

    // Dev Mode state
    let devMode = false;

    // no tabs needed anymore

    // ฟังก์ชันจัดการ Dev Mode
    function toggleDevMode() {
      devMode = !devMode;
      
      if (devMode) {
        // เปิด Dev Mode
        devModeToggle.innerHTML = '<span>Dev Mode: ON</span>';
        devModeToggle.classList.add('active');
        
        // แสดงฟีเจอร์ Dev Mode
        modelSelection.classList.remove('hidden');
        reloadModelBtn.classList.remove('hidden');
        out.classList.remove('hidden');
        
        // โหลดรายการโมเดล
        loadAvailableModels();
        
        console.log('Dev Mode enabled');
      } else {
        // ปิด Dev Mode
        devModeToggle.innerHTML = '<span>Dev Mode: OFF</span>';
        devModeToggle.classList.remove('active');
        
        // ซ่อนฟีเจอร์ Dev Mode
        modelSelection.classList.add('hidden');
        reloadModelBtn.classList.add('hidden');
        out.classList.add('hidden');
        processCards.classList.add('hidden');
        modelInfo.classList.add('hidden');
        
        // ตั้งค่าโมเดลเป็น default
        modelSelect.value = 'MobileNetV2_Augmented_best.keras';
        
        console.log('Dev Mode disabled');
      }
    }

    // Event listener สำหรับปุ่ม Dev Mode
    devModeToggle.addEventListener('click', toggleDevMode);

    // Debounce function for performance
    function debounce(func, wait) {
      let timeout;
      return function executedFunction(...args) {
        const later = () => {
          clearTimeout(timeout);
          func(...args);
        };
        clearTimeout(timeout);
        timeout = setTimeout(later, wait);
      };
    }

    // Throttle function for scroll events
    function throttle(func, limit) {
      let inThrottle;
      return function() {
        const args = arguments;
        const context = this;
        if (!inThrottle) {
          func.apply(context, args);
          inThrottle = true;
          setTimeout(() => inThrottle = false, limit);
        }
      };
    }

    // Upload Area Drag & Drop
    const uploadArea = document.getElementById('upload-area');
    
    uploadArea.addEventListener('click', () => {
      document.getElementById('file').click();
    });
    
    uploadArea.addEventListener('dragover', (e) => {
      e.preventDefault();
      uploadArea.classList.add('dragover');
    });
    
    uploadArea.addEventListener('dragleave', () => {
      uploadArea.classList.remove('dragover');
    });
    
    uploadArea.addEventListener('drop', (e) => {
      e.preventDefault();
      uploadArea.classList.remove('dragover');
      const files = e.dataTransfer.files;
      if (files.length > 0) {
        document.getElementById('file').files = files;
        updateUploadText(files[0]);
      }
    });
    
    // Update upload text when file is selected
    document.getElementById('file').addEventListener('change', (e) => {
      if (e.target.files.length > 0) {
        updateUploadText(e.target.files[0]);
      }
    });
    
    function updateUploadText(file) {
      const uploadText = document.querySelector('.upload-text');
      const uploadSubtext = document.querySelector('.upload-subtext');
      uploadText.textContent = `เลือกไฟล์: ${file.name}`;
      uploadSubtext.textContent = `ขนาด: ${(file.size / 1024 / 1024).toFixed(2)} MB`;
    }

    // Performance Monitoring
    const performanceMonitor = {
      startTime: performance.now(),
      
      logPageLoad: function() {
        window.addEventListener('load', () => {
          const loadTime = performance.now() - this.startTime;
          console.log(`🚀 Page loaded in ${loadTime.toFixed(2)}ms`);
          
          // Log Core Web Vitals
          this.logCoreWebVitals();
        });
      },
      
      logAPICall: function(url, startTime) {
        return () => {
          const endTime = performance.now();
          const duration = endTime - startTime;
          console.log(`📡 API ${url} completed in ${duration.toFixed(2)}ms`);
          
          // Performance rating
          if (duration < 1000) {
            console.log(`✅ Excellent API performance!`);
          } else if (duration < 5000) {
            console.log(`⚠️ Good API performance`);
          } else if (duration < 10000) {
            console.log(`🐌 Slow API performance - consider optimization`);
          } else {
            console.log(`🚨 Very slow API performance - ${(duration/1000).toFixed(1)}s - needs optimization!`);
          }
          
          // AI Processing specific recommendations
          if (url.includes('/predict')) {
            if (duration > 10000) {
              console.log(`💡 AI Processing Tips:`);
              console.log(`   - Consider using smaller model`);
              console.log(`   - Implement model caching`);
              console.log(`   - Use GPU acceleration`);
              console.log(`   - Optimize image preprocessing`);
              console.log(`   - Implement async processing`);
              console.log(`   - Use model quantization`);
            } else if (duration > 5000) {
              console.log(`💡 AI Processing Tips:`);
              console.log(`   - Consider model optimization`);
              console.log(`   - Implement response caching`);
              console.log(`   - Use batch processing`);
            }
          }
        };
      },
      
      logImageLoad: function(imageElement) {
        const startTime = performance.now();
        imageElement.addEventListener('load', () => {
          const loadTime = performance.now() - startTime;
          console.log(`🖼️ Image loaded in ${loadTime.toFixed(2)}ms`);
          
          // Performance rating for images
          if (loadTime < 100) {
            console.log(`✅ Excellent image load time!`);
          } else if (loadTime < 1000) {
            console.log(`⚠️ Good image load time`);
          } else if (loadTime < 5000) {
            console.log(`🐌 Slow image load - consider compression`);
          } else {
            console.log(`🚨 Very slow image load - ${(loadTime/1000).toFixed(1)}s - needs optimization!`);
            
            // Image optimization tips
            console.log(`💡 Image Optimization Tips:`);
            console.log(`   - Compress images before sending`);
            console.log(`   - Use WebP format for better compression`);
            console.log(`   - Implement progressive loading`);
            console.log(`   - Consider lazy loading for non-critical images`);
            console.log(`   - Use CDN for image delivery`);
          }
        });
      },
      
      logCoreWebVitals: function() {
        // Log performance metrics
        const navigation = performance.getEntriesByType('navigation')[0];
        if (navigation) {
          console.log(`📊 Performance Metrics:`);
          console.log(`   - DNS Lookup: ${(navigation.domainLookupEnd - navigation.domainLookupStart).toFixed(2)}ms`);
          console.log(`   - TCP Connect: ${(navigation.connectEnd - navigation.connectStart).toFixed(2)}ms`);
          console.log(`   - DOM Content Loaded: ${(navigation.domContentLoadedEventEnd - navigation.domContentLoadedEventStart).toFixed(2)}ms`);
          console.log(`   - Total Load Time: ${(navigation.loadEventEnd - navigation.loadEventStart).toFixed(2)}ms`);
          
          // Performance score
          const totalTime = navigation.loadEventEnd - navigation.loadEventStart;
          if (totalTime < 100) {
            console.log(`🏆 Performance Score: EXCELLENT (${totalTime.toFixed(2)}ms)`);
          } else if (totalTime < 500) {
            console.log(`🥇 Performance Score: GOOD (${totalTime.toFixed(2)}ms)`);
          } else if (totalTime < 1000) {
            console.log(`🥈 Performance Score: FAIR (${totalTime.toFixed(2)}ms)`);
          } else {
            console.log(`🥉 Performance Score: NEEDS IMPROVEMENT (${totalTime.toFixed(2)}ms)`);
          }
          
          // Additional performance insights
          console.log(`💡 Performance Insights:`);
          console.log(`   - Page load time is ${totalTime < 100 ? 'excellent' : totalTime < 500 ? 'good' : 'needs improvement'}`);
          console.log(`   - DNS resolution is ${(navigation.domainLookupEnd - navigation.domainLookupStart) < 10 ? 'fast' : 'slow'}`);
          console.log(`   - TCP connection is ${(navigation.connectEnd - navigation.connectStart) < 50 ? 'fast' : 'slow'}`);
        }
      }
    };

    // Initialize performance monitoring
    performanceMonitor.logPageLoad();

    // Intersection Observer for lazy loading
    const imageObserver = new IntersectionObserver((entries, observer) => {
      entries.forEach(entry => {
        if (entry.isIntersecting) {
          const img = entry.target;
          if (img.dataset.src) {
            img.src = img.dataset.src;
            img.removeAttribute('data-src');
            observer.unobserve(img);
          }
        }
      });
    }, {
      rootMargin: '50px 0px',
      threshold: 0.01
    });

    // Observe all images with data-src attribute
    document.addEventListener('DOMContentLoaded', () => {
      const lazyImages = document.querySelectorAll('img[data-src]');
      lazyImages.forEach(img => imageObserver.observe(img));
    });

    // ฟังก์ชันสำหรับ syntax highlighting JSON
    function syntaxHighlight(json) {
      if (typeof json != "string") {
        json = JSON.stringify(json, undefined, 2);
      }
      json = json.replace(/&/g, "&amp;").replace(/</g, "&lt;").replace(/>/g, "&gt;");
      return json.replace(/("(\\u[a-zA-Z0-9]{4}|\\[^u]|[^\\"])*"(\s*:)?|\b(true|false|null)\b|-?\d+(?:\.\d*)?(?:[eE][+\-]?\d+)?)/g, function (match) {
        var cls = 'json-number';
        if (/^"/.test(match)) {
          if (/:$/.test(match)) {
            cls = 'json-key';
          } else {
            cls = 'json-string';
            // ตรวจจับและตัดทอน base64 string ที่ยาวเกินไป
            const stringValue = match.substring(1, match.length - 1); // ลบเครื่องหมายคำพูดออก
            if (stringValue.startsWith('data:image/') && stringValue.includes(';base64,')) {
              const maxLength = 150; // ความยาวสูงสุดที่ต้องการแสดง
              if (stringValue.length > maxLength) {
                const start = stringValue.substring(0, 75);
                const end = stringValue.substring(stringValue.length - 75);
                match = `"${start}...[truncated base64 data]...${end}"`;
              }
            }
          }
        } else if (/true|false/.test(match)) {
          cls = 'json-boolean';
        } else if (/null/.test(match)) {
          cls = 'json-null';
        }
        return '<span class="' + cls + '">' + match + '</span>';
      });
    }

    // โหลดรายการโมเดลที่มีอยู่เมื่อหน้าเว็บโหลด
    async function loadAvailableModels() {
      try {
        const resp = await fetch('/available-models');
        const data = await resp.json();
        
        if (data.ok && data.models) {
          // ล้างตัวเลือกเก่า
          modelSelect.innerHTML = '';
          
          // เพิ่มตัวเลือกใหม่
          data.models.forEach(modelName => {
            const option = document.createElement('option');
            option.value = modelName;
            
            // แสดงชื่อโมเดลที่อ่านง่าย
            let displayName = modelName;
            if (modelName.includes('EfficientNetB0_Augmented')) {
              displayName = 'EfficientNetB0 (Augmented)';
            } else if (modelName.includes('EfficientNetV2B0_Original')) {
              displayName = 'EfficientNetV2B0 (Original)';
            }
            
            option.textContent = displayName;
            modelSelect.appendChild(option);
          });
          
          console.log(`Loaded ${data.models.length} available models`);
        }
      } catch (err) {
        console.error('Failed to load available models:', err);
      }
    }

    // โหลดรายการโมเดลเมื่อหน้าเว็บโหลด
    loadAvailableModels();

    // ฟังก์ชันเปลี่ยนโมเดล
    modelSelect.addEventListener('change', async (e) => {
      const selectedModel = e.target.value;
      console.log('Model changed to:', selectedModel);
      
      // แสดงสถานะการเปลี่ยนโมเดล
      const statusDiv = document.createElement('div');
      statusDiv.id = 'model-switch-status';
      statusDiv.style.cssText = 'background: #fff3cd; padding: 8px; border-radius: 4px; margin: 8px 0; border-left: 4px solid #ffc107;';
      statusDiv.innerHTML = `🔄 กำลังเปลี่ยนโมเดลเป็น: ${selectedModel}...`;
      
      // ลบสถานะเก่าถ้ามี
      const oldStatus = document.getElementById('model-switch-status');
      if (oldStatus) oldStatus.remove();
      
      // แทรกสถานะใหม่
      form.parentNode.insertBefore(statusDiv, form.nextSibling);
      
      try {
        // เรียก API เพื่อเปลี่ยนโมเดล
        const resp = await fetch('/switch-model', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
          },
          body: JSON.stringify({ model_name: selectedModel })
        });
        
        const data = await resp.json();
        
        if (data.ok) {
          statusDiv.style.cssText = 'background: #d4edda; padding: 8px; border-radius: 4px; margin: 8px 0; border-left: 4px solid #28a745;';
          statusDiv.innerHTML = `✅ เปลี่ยนโมเดลเรียบร้อยแล้ว: ${data.model_info?.model_name || selectedModel}`;
          
          // อัพเดทข้อมูลโมเดล
          if (data.model_info) {
            modelDetails.innerHTML = `
              <div><strong>Model Name:</strong> ${data.model_info.model_name}</div>
              <div><strong>File Size:</strong> ${data.model_info.file_size_mb} MB</div>
              <div><strong>Path:</strong> ${data.model_info.model_path}</div>
            `;
            modelInfo.style.display = 'block';
          }
          
          // ลบสถานะหลังจาก 3 วินาที
          setTimeout(() => {
            if (statusDiv.parentNode) {
              statusDiv.remove();
            }
          }, 3000);
        } else {
          throw new Error(data.error || 'ไม่สามารถเปลี่ยนโมเดลได้');
        }
      } catch (err) {
        console.error('Model switch error:', err);
        statusDiv.style.cssText = 'background: #f8d7da; padding: 8px; border-radius: 4px; margin: 8px 0; border-left: 4px solid #dc3545;';
        statusDiv.innerHTML = `❌ เกิดข้อผิดพลาด: ${err.message}`;
        
        // ลบสถานะหลังจาก 5 วินาที
        setTimeout(() => {
          if (statusDiv.parentNode) {
            statusDiv.remove();
          }
        }, 5000);
      }
    });

    // รีโหลดโมเดล
    reloadModelBtn.addEventListener('click', async () => {
      reloadModelBtn.disabled = true;
      reloadModelBtn.textContent = 'กำลังรีโหลด...';
      
      try {
        // ลองตรวจสอบ endpoint ก่อน
        const checkResp = await fetch('/health');
        if (!checkResp.ok) {
          throw new Error(`Health check failed: ${checkResp.status}`);
        }
        
        // ลองใช้ GET ก่อน
        let resp = await fetch('/reload-model', { method: 'GET' });
        
        if (resp.ok) {
          const checkData = await resp.json();
          console.log('GET /reload-model response:', checkData);
        }
        
        // ใช้ POST สำหรับรีโหลดจริง
        resp = await fetch('/reload-model', { method: 'POST' });
        
        if (!resp.ok) {
          throw new Error(`HTTP error! status: ${resp.status}`);
        }
        
        const data = await resp.json();
        
        if (data.ok) {
          alert('รีโหลดโมเดลเรียบร้อยแล้ว! โมเดลใหม่: ' + (data.model_info?.model_name || 'Unknown'));
          // รีเฟรชข้อมูลโมเดล
          const modelResp = await fetch('/model-info');
          const modelData = await modelResp.json();
          
          if (modelData.model_name) {
            modelDetails.innerHTML = `
              <div><strong>Model Name:</strong> ${modelData.model_name}</div>
              <div><strong>File Size:</strong> ${modelData.file_size_mb} MB</div>
              <div><strong>Path:</strong> ${modelData.model_path}</div>
            `;
            modelInfo.style.display = 'block';
          }
        } else {
          const errorMsg = data.error || 'ไม่ทราบสาเหตุ';
          alert('ไม่สามารถรีโหลดโมเดลได้: ' + errorMsg);
        }
      } catch (err) {
        console.error('Reload model error:', err);
        alert('เกิดข้อผิดพลาดในการเชื่อมต่อ: ' + err.message + '\n\nกรุณารีสตาร์ทแอปแล้วลองใหม่');
      } finally {
        reloadModelBtn.disabled = false;
        reloadModelBtn.textContent = 'รีโหลดโมเดล';
      }
    });

    // ฟังก์ชันแสดงภาพขั้นตอนการประมวลผล
    function displayProcessSteps(steps) {
      console.log('Displaying process steps:', steps);
      
      const stepConfigs = [
        { key: 'band_crop', id: 'band-crop-image' },
        { key: 'threshold', id: 'threshold-image' },
        { key: 'projection', id: 'projection-image' },
        { key: 'boxes', id: 'boxes-image' },
        { key: 'crop', id: 'crop-image' },
        { key: 'square_pad', id: 'square-pad-image' },
        { key: 'resize244', id: 'resize244-image' },
        { key: 'grayscale_rgb', id: 'grayscale-rgb-image' }
      ];
      
      stepConfigs.forEach(({ key, id }) => {
        if (steps[key]) {
          console.log(`Setting ${key} image`);
          const imgElement = document.getElementById(id);
          
          if (imgElement) {
            // Set loading state
            imgElement.setAttribute('data-loaded', 'false');
            imgElement.style.opacity = '0';
            
            // Monitor performance
            performanceMonitor.logImageLoad(imgElement);
            
            // Load image
            imgElement.src = steps[key];
            
            // Show when loaded
            imgElement.onload = () => {
              imgElement.setAttribute('data-loaded', 'true');
              imgElement.style.opacity = '1';
            };
          }
        }
      });
      // ขั้นตอน Final Input ถูกลบออกแล้ว
    }

    form.addEventListener('submit', async (e) => {
      e.preventDefault();
      const file = document.getElementById('file').files[0];
      if (!file) return;

      const fd = new FormData();
      fd.append('file', file);

      // ส่งข้อมูลโมเดลเฉพาะใน Dev Mode
      if (devMode) {
        fd.append('model_name', modelSelect.value);
      } else {
        // ในโหมดปกติ ใช้โมเดล default
        fd.append('model_name', 'MobileNetV2_Augmented_best.keras');
      }

      // แสดงการ์ดภาพทั้งสองใบ
      imageCards.classList.add('hidden');
      modelInfo.classList.add('hidden');
      detectionInfo.classList.add('hidden');
      
      // แสดง progress indicator (แสดงในทุกโหมด)
      const progressDiv = document.createElement('div');
      progressDiv.id = 'progress-indicator';
      progressDiv.className = 'status-message status-info';
      
      const fileSize = (file.size / 1024 / 1024).toFixed(1);
      let progressText = '⏳ กำลังประมวลผลภาพ...';
      if (fileSize > 2) {
        progressText += `<br><small>ภาพขนาดใหญ่ (${fileSize} MB) - อาจใช้เวลานาน</small>`;
      } else if (fileSize > 0.5) {
        progressText += `<br><small>ภาพขนาดกลาง (${fileSize} MB) - กรุณารอสักครู่...</small>`;
      } else {
        progressText += `<br><small>ภาพขนาดเล็ก (${fileSize} MB) - ประมวลผลเร็ว</small>`;
      }
      
      progressDiv.innerHTML = progressText;
      
      // แทรก progress indicator หลัง form
      form.parentNode.insertBefore(progressDiv, form.nextSibling);
      
      console.log('Progress indicator created and inserted');
      
      // แสดง JSON output เฉพาะใน Dev Mode
      if (devMode) {
        out.innerHTML = '<pre>กำลังตรวจจับตัวเลข...</pre>';
        out.classList.remove('hidden');
      } else {
        // แสดงข้อความแจ้งเตือนในโหมดปกติ
        const statusDiv = document.createElement('div');
        statusDiv.id = 'status-message';
        statusDiv.className = 'status-message status-info';
        statusDiv.innerHTML = '⏳ กำลังประมวลผลภาพ... กรุณารอสักครู่';
        form.parentNode.insertBefore(statusDiv, form.nextSibling);
      }
      
      // ปิดการใช้งานปุ่ม submit ชั่วคราว
      const submitBtn = form.querySelector('button[type="submit"]');
      submitBtn.disabled = true;
      submitBtn.textContent = 'กำลังประมวลผล...';

      try {
        console.log('Sending request to /predict with model:', devMode ? modelSelect.value : 'MobileNetV2_Augmented_best.keras');
        const apiStartTime = performance.now();
        const resp = await fetch('/predict', { method: 'POST', body: fd });
        console.log('Response status:', resp.status);
        const data = await resp.json();
        console.log('Response data:', data);
        
        // Log API performance
        performanceMonitor.logAPICall('/predict', apiStartTime)();
        
        // แสดง JSON output เฉพาะใน Dev Mode
        if (devMode) {
          out.innerHTML = '<pre>' + syntaxHighlight(JSON.stringify(data, null, 2)) + '</pre>';
          out.classList.remove('hidden');
        }
        
        // ลบ progress indicator และ status message
        const progressDiv = document.getElementById('progress-indicator');
        if (progressDiv) {
          progressDiv.remove();
        }
        
        const statusDiv = document.getElementById('status-message');
        if (statusDiv) {
          statusDiv.remove();
        }
        
        // เปิดใช้งานปุ่ม submit กลับ
        const submitBtn = form.querySelector('button[type="submit"]');
        submitBtn.disabled = false;
        submitBtn.textContent = 'ตรวจจับตัวเลข';
        
        // แสดงข้อมูลโมเดล (เฉพาะใน Dev Mode)
        if (devMode && data.ok && data.model_info) {
          modelDetails.innerHTML = `
            <div class="model-detail-item">
              <div class="model-detail-label">Model Name</div>
              <div class="model-detail-value">${data.model_info.name}</div>
            </div>
            <div class="model-detail-item">
              <div class="model-detail-label">File Size</div>
              <div class="model-detail-value">${data.model_info.size_mb} MB</div>
            </div>
            <div class="model-detail-item">
              <div class="model-detail-label">Path</div>
              <div class="model-detail-value">${data.model_info.path}</div>
            </div>
          `;
          modelInfo.classList.remove('hidden');
          modelInfo.classList.add('fade-in');
        }
        
        // แสดงภาพทั้งสองใบ
        if (data.ok && data.preview_base64) {
          // Set loading state
          originalImage.setAttribute('data-loaded', 'false');
          originalImage.style.opacity = '0';
          
          // Load image with performance monitoring
          performanceMonitor.logImageLoad(originalImage);
          originalImage.src = data.preview_base64;
          
          // Show image when loaded
          originalImage.onload = () => {
            originalImage.setAttribute('data-loaded', 'true');
            originalImage.style.opacity = '1';
          };
          
          imageCards.classList.remove('hidden');
          imageCards.classList.add('fade-in');
          
          // แสดง process cards เฉพาะใน Dev Mode
          if (devMode) {
            processCards.classList.remove('hidden');
            processCards.classList.add('fade-in');
          }
          
          // แสดงข้อความแจ้งเตือนเมื่อประมวลผลสำเร็จในโหมดปกติ
          if (!devMode) {
            const processingDiv = document.createElement('div');
            processingDiv.className = 'status-message status-success';
            processingDiv.innerHTML = '✅ ประมวลผลภาพเสร็จสิ้น';
            form.parentNode.insertBefore(processingDiv, form.nextSibling);
            
            // ลบข้อความแจ้งเตือนหลังจาก 2 วินาที
            setTimeout(() => {
              if (processingDiv.parentNode) {
                processingDiv.remove();
              }
            }, 2000);
          }
        }
        if (data.ok && data.preview_with_boxes_base64) {
          detectionImage.src = data.preview_with_boxes_base64;
          if (noDetectionNote) noDetectionNote.classList.add('hidden');
        } else {
          // หากไม่มีภาพที่วาดกรอบ ให้ใช้ภาพเดิมและแจ้งผู้ใช้
          detectionImage.src = data.preview_base64 || '';
          if (noDetectionNote) noDetectionNote.classList.remove('hidden');
        }

        // แสดงภาพขั้นตอนการประมวลผล (เฉพาะใน Dev Mode)
        if (devMode) {
        console.log('Full response data:', data);
        if (data.process_steps) {
          console.log('Process steps received:', Object.keys(data.process_steps));
          displayProcessSteps(data.process_steps);
            processCards.classList.remove('hidden');
            processCards.classList.add('fade-in');
        } else if (data.result && data.result.process_steps) {
          console.log('Process steps in result:', Object.keys(data.result.process_steps));
          displayProcessSteps(data.result.process_steps);
            processCards.classList.remove('hidden');
            processCards.classList.add('fade-in');
        } else {
          console.log('No process steps received');
          }
        }
        
        // แสดงข้อมูลการตรวจจับวัตถุ
        if (data.ok && data.result && data.result.detections && data.result.detections.length > 0) {
          const detections = data.result.detections;
          const stats = data.result.detection_stats || {};
          
          let detectionHTML = `<div><strong>พบตัวเลข ${detections.length} ตัว:</strong></div>`;
          
          // แสดงสถิติคลาส
          if (stats.class_counts) {
            detectionHTML += `<div style="margin: 8px 0; padding: 8px; background: #f8f9fa; border-radius: 4px;">`;
            detectionHTML += `<strong>ตัวเลขที่พบ:</strong><br>`;
            for (const [classId, count] of Object.entries(stats.class_counts)) {
              detectionHTML += `เลข ${classId}: ${count} ตัว<br>`;
            }
            detectionHTML += `</div>`;
          }
          
          detections.forEach((detection, index) => {
            const position = detection.position || (index + 1); // ใช้ position หรือ index + 1
            detectionHTML += `
              <div class="detection-item">
                <div>
                  <span class="detection-class">เลข ${detection.class_name}</span>
                  <div style="font-size: 0.8em; color: #666;">
                    ตำแหน่ง: ${position}
                  </div>
                  <div style="font-size: 0.7em; color: #999;">
                    พิกัด: (${detection.bbox[0]}, ${detection.bbox[1]}) ถึง (${detection.bbox[2]}, ${detection.bbox[3]})
                  </div>
                </div>
                <div class="detection-confidence">${(detection.confidence * 100).toFixed(1)}%</div>
              </div>
            `;
          });
          
          detectionDetails.innerHTML = detectionHTML;
          detectionInfo.classList.remove('hidden');
          detectionInfo.classList.add('fade-in');
          
          // แสดงข้อความแจ้งเตือนเมื่อพบการตรวจจับในโหมดปกติ
          if (!devMode) {
            const successDiv = document.createElement('div');
            successDiv.className = 'status-message status-success';
            successDiv.innerHTML = `🎯 พบตัวเลข ${detections.length} ตัวในภาพ`;
            form.parentNode.insertBefore(successDiv, form.nextSibling);
            
            // ลบข้อความแจ้งเตือนหลังจาก 3 วินาที
            setTimeout(() => {
              if (successDiv.parentNode) {
                successDiv.remove();
              }
            }, 3000);
          }
        } else if (data.ok && (!data.result || !data.result.detections || data.result.detections.length === 0)) {
          // แสดงข้อความเมื่อไม่พบการตรวจจับในโหมดปกติ
          if (!devMode) {
            const noDetectionDiv = document.createElement('div');
            noDetectionDiv.className = 'status-message status-warning';
            noDetectionDiv.innerHTML = '⚠️ ไม่พบการตรวจจับตัวเลขในภาพนี้';
            form.parentNode.insertBefore(noDetectionDiv, form.nextSibling);
            
            // ลบข้อความแจ้งเตือนหลังจาก 5 วินาที
            setTimeout(() => {
              if (noDetectionDiv.parentNode) {
                noDetectionDiv.remove();
              }
            }, 5000);
          }
        }
        
      } catch (err) {
        if (devMode) {
          out.innerHTML = '<pre>' + syntaxHighlight(JSON.stringify({error: String(err)}, null, 2)) + '</pre>';
          out.classList.remove('hidden');
        } else {
          // แสดงข้อความแจ้งเตือนในโหมดปกติ
          const errorDiv = document.createElement('div');
          errorDiv.className = 'status-message status-error';
          errorDiv.innerHTML = `❌ เกิดข้อผิดพลาด: ${err.message || 'ไม่สามารถประมวลผลภาพได้'}`;
          form.parentNode.insertBefore(errorDiv, form.nextSibling);
          
          // ลบข้อความแจ้งเตือนหลังจาก 5 วินาที
          setTimeout(() => {
            if (errorDiv.parentNode) {
              errorDiv.remove();
            }
          }, 5000);
        }
        
        // ลบ progress indicator และ status message ในกรณี error
        const progressDiv = document.getElementById('progress-indicator');
        if (progressDiv) {
          progressDiv.remove();
        }
        
        const statusDiv = document.getElementById('status-message');
        if (statusDiv) {
          statusDiv.remove();
        }
        
        // เปิดใช้งานปุ่ม submit กลับ
        const submitBtn = form.querySelector('button[type="submit"]');
        submitBtn.disabled = false;
        submitBtn.textContent = 'ตรวจจับตัวเลข';
      }
    });
  </script>
</body>
</html>
